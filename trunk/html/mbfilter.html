<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML VERSION="2.0">
<HEAD>
   <TITLE>MB-System Unix Manual Page: mbfilter</TITLE>
<!-- WEBMAGIC VERSION NUMBER="2.0.2" -->
<!-- WEBMAGIC TRANSLATION NAME="ServerRoot" SRC="/var/www/htdocs/" DST="/" -->
<!-- WEBMAGIC TRANSLATION NAME="ProjectRoot" SRC="./" DST="" -->
</HEAD>
<BODY TEXT="#000000" BGCOLOR="#FFFFFF" LINK="#336699" VLINK="#997040" ALINK="#CC9900">
<BODY>
<CENTER><H3><U>MB-System Unix Manual Page</U></H3></CENTER>
<PRE>
<H1>mbfilter</H1>
Section: MB-System 5.0 (l)<BR>Updated: 9 August 2001<BR><A HREF="#index">Index</A>
<HR>

<A NAME="lbAB">&nbsp;</A>
<H2>NAME</H2>

<B>mbfilter</B> - Apply some simple filter functions to sidescan, beam
amplitude, or bathymetry data from swath sonar data files.
<P>
<A NAME="lbAC">&nbsp;</A>
<H2>VERSION</H2>

Version 5.0
<P>
<A NAME="lbAD">&nbsp;</A>
<H2>SYNOPSIS</H2>

<B>mbfilter</B> [<B>-A</B><I>kind</I> 
<B>-B</B><I>yr/mo/da/hr/mn/sc 
</I><B>-C</B><I>mode/xdim/ldim/iteration</I> 
<B>-D</B><I>mode/xdim/ldim/iteration/offset</I> 
<B>-E</B><I>yr/mo/da/hr/mn/sc 
</I><B>-F</B><I>format</I> <B>-I</B><I>infile</I> <B>-N</B><I>buffersize</I>
<B>-O</B><I>outfile</I> <B>-R</B><I>west/east/south/north</I> 
<B>-S</B><I>mode/xdim/ldim/iteration</I> 
<B>-T</B><I>threshold_lo/threshold_hi</I>
<B>-V -H</B>]
<P>
<A NAME="lbAE">&nbsp;</A>
<H2>DESCRIPTION</H2>

<B>mbfilter</B> applies one or more simple filters to the specified
swath data (sidescan, beam amplitude, and/or bathymetry). The filters
include:
<BR>&nbsp;&nbsp;-&nbsp;boxcar&nbsp;mean&nbsp;for&nbsp;lo-pass&nbsp;filtering
<BR>&nbsp;&nbsp;-&nbsp;gaussian&nbsp;mean&nbsp;for&nbsp;lo-pass&nbsp;filtering
<BR>&nbsp;&nbsp;-&nbsp;boxcar&nbsp;median&nbsp;for&nbsp;lo-pass&nbsp;filtering
<BR>&nbsp;&nbsp;-&nbsp;inverse&nbsp;gradient&nbsp;for&nbsp;lo-pass&nbsp;filtering
<BR>&nbsp;&nbsp;-&nbsp;boxcar&nbsp;mean&nbsp;subtraction&nbsp;for&nbsp;hi-pass&nbsp;filtering
<BR>&nbsp;&nbsp;-&nbsp;gaussian&nbsp;mean&nbsp;subtraction&nbsp;for&nbsp;hi-pass&nbsp;filtering
<BR>&nbsp;&nbsp;-&nbsp;boxcar&nbsp;median&nbsp;subtraction&nbsp;for&nbsp;hi-pass&nbsp;filtering
<BR>&nbsp;&nbsp;-&nbsp;edge&nbsp;detection&nbsp;for&nbsp;contrast&nbsp;enhancement
<BR>&nbsp;&nbsp;-&nbsp;gradient&nbsp;magnitude&nbsp;subtraction&nbsp;for&nbsp;contrast&nbsp;enhancement
<P>
These filters are mostly intended for use with sidescan
data. In particular, the lo-pass or smoothing filters
can be used for first-order speckle reduction in sidescan
data, and the hi-pass filters can be used to emphasize
fine scale structure in the data. A combination of
lo-pass and hi-pass filtering can effectively perform
band-pass filtering. The contrast enhancing
filters can, under certain circumstances, sharpen sidescan
images of the seafloor. The lo-pass and contrast
enhancement filters are described
in the paper by Sauter and Parson (1994) listed below.
<P>
The filtering used here is designed and applied in the
same manner as spatial filters are applied to images.
The swath data is treated as an image, with the x and
y coordinates corresponding to pixel (or beam) number and
ping number, respectively. The filters consist of M x N
matrices which are convolved with the swath data image
(M is the filter dimension in the acrosstrack direction
and N is the filter dimension in the alongtrack direction).
Missing or flagged data are ignored in the filtering
process.
<P>
Users can apply up to three filters at a time (one each of
the lo-pass, hi-pass, and contrast enhancement filters).
If multiple filters are applied, the hi-pass will be
applied first, followed by the lo-pass, followed
finally by the contrast enhancement filter.
Users can apply as many iterations of each filter as
desired.
<P>
The user specifies the window size
used by the filters (3x3 or 5x5 are typical for using smoothing
filters iteratively to reduce speckle; larger windows like 3x20
are typical for hi-pass filtering). 
<P>
The boxcar mean, gaussian mean, and median filter all
achieve similar results in uniformly smoothing the data; 
the boxcar mean is faster to apply, the gaussian mean preserves
the frequency content of the data better, and the median filter
is least sensitive to spikes in the data. The inverse 
gradient filter applies averaging weights which depend on the
inverse gradient of the data. This approach causes the filter
to smooth regions without distinct edges much more than regions
with edges, thus tending to preserve the sharpness of features
more than the simpler smoothing filters. 
<P>
The median smoothing filter can be set by the <B>-T</B>
option to operate with low and high
ratio thresholds (the value is changed only if the original
value divided by the median value is less than the low
threshold or greater than the high threshold). This allows the
filter to preferentially despike the data. In particular, this
approach is useful for suppressing &quot;stripes&quot; or &quot;bad&quot; 
pings which have amplitude or sidescan values differing significantly
from surrounding pings.
<P>
The hi-pass filters are constructed by calculating a low-pass
filtered version of the data and then subtracting that from
the original data. An offset value is added to the hi-passed
data so that it is positive (negative values are considered
flagged as bad in some formats and not allowed in others). 
The hi-pass filters can be used to remove
long-wavelength variations in seafloor reflectivity in order
to emphasize fine-scale structure.
<P>
The contrast enhancement filters are generally only successful
when applied after smoothing because of their tendency to
amplify noise. The edge detection filter enhances contrast by
tending to shift values on either side of a boundary away
from the average value across the boundary. A 5 X 5 filter or
larger is generally required for success with the edge detection
algorithm. The gradient filter increases contrast by subtracting
twice the local gradient magnitude from each value.
<P>
The default input and output streams are stdin and stdout.
<P>
<A NAME="lbAF">&nbsp;</A>
<H2>AUTHORSHIP</H2>

David W. Caress (<A HREF="mailto:caress@mbari.org">caress@mbari.org</A>)
<BR>

<BR>&nbsp;&nbsp;Monterey&nbsp;Bay&nbsp;Aquarium&nbsp;Research&nbsp;Institute
<BR>

Dale N. Chayes (<A HREF="mailto:dale@ldeo.columbia.edu">dale@ldeo.columbia.edu</A>)
<BR>

<BR>&nbsp;&nbsp;Lamont-Doherty&nbsp;Earth&nbsp;Observatory
<BR>&nbsp;
<A NAME="lbAG">&nbsp;</A>
<H2>OPTIONS</H2>

<DL COMPACT>
<DT><B>-A</B>

<DD>
<I>kind</I>
<BR>

Determines whether bathymetry (<I>kind</I> = 0),
beam amplitude (<I>kind</I> = 1), 
or sidescan (<I>kind</I> = 2) data will be processed. 
Default: <I>kind</I> = 2.
<DT><B>-B</B>

<DD>
<I>yr/mo/da/hr/mn/sc</I>
<BR>

This option sets the starting time for data allowed in the input data.
The <B>-E</B> option sets the ending time for data. If the 
starting time is before the ending time, then any data
with a time stamp before the starting time or after the
ending time is ignored. If instead the starting time is
after the ending time, then any data between the ending
and starting time will be ignored. This scheme allows time
windowing both inside and outside a specified interval.
Default: <I>yr/mo/da/hr/mn/sc</I> = 1962/2/21/10/30/0.
<DT><B>-C</B>

<DD>
<I>mode/xdim/ldim/iteration</I>
<BR>

<BR>

Turns on contrast enhancement filtering and sets the 
filter parameters to be 
used. Here <I>mode</I> specifies the filter type:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;1&nbsp;:&nbsp;Edge&nbsp;Detection&nbsp;Filter<BR>
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;2&nbsp;:&nbsp;Gradient&nbsp;Magnitude&nbsp;Subtraction&nbsp;Filter<BR>
<BR>

The dimensions of the data window used are set using <I>xdim</I>
(acrosstrack dimension) and <I>ldim</I> (alongtrack dimension).
Values of <I>xdim</I> = 5 and <I>ldim</I> = 5 are typical, but
larger or smaller dimensions can be used. 
The <I>iteration</I> value specifies
the number of times the filter is applied; there is no limit to
this value. 
Default: contrast enhancement off, <I>xdim</I> = 5, <I>ldim</I> = 5, 
<I>iteration</I> = 1.
<DT><B>-D</B>

<DD>
<I>mode/xdim/ldim/iteration/offset</I>
<BR>

Turns on hi-pass filtering and sets the filter parameters to be 
used. Here <I>mode</I> specifies the filter type:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;1&nbsp;:&nbsp;Boxcar&nbsp;Mean&nbsp;Subtraction&nbsp;Filter<BR>
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;2&nbsp;:&nbsp;Gaussian&nbsp;Mean&nbsp;Subtraction&nbsp;Filter<BR>
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;3&nbsp;:&nbsp;Boxcar&nbsp;Median&nbsp;Subtraction&nbsp;Filter<BR>
<BR>

The dimensions of the data window used are set using <I>xdim</I>
(acrosstrack dimension) and <I>ldim</I> (alongtrack dimension).
Values of <I>xdim</I> = 3 and <I>ldim</I> = 3 are typical, but
larger dimensions can be used. The <I>iteration</I> value specifies
the number of times the filter is applied; there is no limit to
this value, but high-pass filters are generally only applied
once. The <I>offset</I> value is added to each hi-pass filtered
value to force the results to be positive; this value should be 
chosen according to the range of values allowed in the
data type and data formats being used (e.g. for SeaBeam 2100
sidescan as represented in format 41, the sidescan values
can range from 1 to 65535, so an <I>offset</I> = 1000 is appropriate).
Default: hi-pass filtering off, <I>xdim</I> = 3, <I>ldim</I> = 10, 
<I>iteration</I> = 1, <I>offset</I> = 1000.
<DT><B>-E</B>

<DD>
<I>yr/mo/da/hr/mn/sc</I>
<BR>

This option sets the ending time for data allowed in the input data.
The <B>-B</B> option sets the starting time for data. If the 
starting time is before the ending time, then any data
with a time stamp before the starting time or after the
ending time is ignored. If instead the starting time is
after the ending time, then any data between the ending
and starting time will be ignored. This scheme allows time
windowing both inside and outside a specified interval.
Default: <I>yr/mo/da/hr/mn/sc</I> = 2062/2/21/10/30/0.
<DT><B>-F</B>

<DD>
<I>format</I>
<BR>

Sets the data format used in reading the input from stdin
or from a file. This program uses the <B>MBIO</B> library 
and will read or write any swath sonar
format supported by <B>MBIO</B>. A list of the swath sonar data formats
currently supported by <B>MBIO</B> and their identifier values
is given in the <B>MBIO</B> manual page. Default: <I>format</I> = 11.
<DT><B>-H</B>

<DD>
This &quot;help&quot; flag causes the program to print out a description
of its operation and then exit immediately.
<DT><B>-I</B>

<DD>
<I>infile</I>
<BR>

Sets the input swath sonar data filename. 
This program uses the <B>MBIO</B> library and will read or write any swath sonar
format supported by <B>MBIO</B>. A list of the swath sonar data formats
currently supported by <B>MBIO</B> and their identifier values
is given in the <B>MBIO</B> manual page. Default: <I>infile</I> = &quot;stdin&quot;.
<DT><B>-N</B>

<DD>
<I>buffersize</I>
<BR>

Sets the maximum number of data records which can be
read into the buffer. In general, data records may be
of several different types (e.g. parameter, position, 
comment) in addition to survey data records. Many data 
formats include many more position data records than
survey data records. Thus, a large buffer may be required
to access a reasonable number of survey data records. 
However, on memory limited machines large buffer sizes
can lead to poor performance due to memory swapping. 
The default value of <I>buffersize</I> = 500 is appropriate 
for most cases, but users can set the buffer size as required.
The absolute maximum buffer size is 5000. 
Default: <I>buffersize</I> = 500.
<DT><B>-O</B>

<DD>
<I>outfile</I>
<BR>

Data file to which the output data will be written. The <B>MBIO</B>
format id used is the same as for the input data. If
no output file is specified, the output will be written to
stdout. Default: <I>outfile</I> = stdout.
<DT><B>-R</B>

<DD>
<I>west/east/south/north</I>
<BR>

Sets the longitude and latitude bounds within which swath sonar 
data will be read. Only the data which lies within these bounds will
be copied. 
Default: <I>west</I>=-360, east<I>=360</I>, <I>south</I>=-90, <I>north</I>=90.
<DT><B>-S</B>

<DD>
<I>mode/xdim/ldim/iteration</I>
<BR>

Turns on lo-pass smoothing filtering and sets the filter 
parameters to be used to 
smooth the data. Here <I>mode</I> specifies the filter type:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;1&nbsp;:&nbsp;Boxcar&nbsp;Mean&nbsp;Filter<BR>
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;2&nbsp;:&nbsp;Gaussian&nbsp;Mean&nbsp;Filter<BR>
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;3&nbsp;:&nbsp;Boxcar&nbsp;Median&nbsp;Filter<BR>
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT><I>mode</I>&nbsp;=&nbsp;4&nbsp;:&nbsp;Boxcar&nbsp;Inverse&nbsp;Gradient&nbsp;Filter<BR>
<BR>

The dimensions of the data window used are set using <I>xdim</I>
(acrosstrack dimension) and <I>ldim</I> (alongtrack dimension).
Values of <I>xdim</I> = 3 and <I>ldim</I> = 3 are typical, but
larger dimensions can be used. The <I>iteration</I> value specifies
the number of times the filter is applied; there is no limit to
this value.
Default: <I>mode</I> = 1, <I>xdim</I> = 3, <I>ldim</I> = 3, 
<I>iteration</I> = 1.
<DT><B>-T</B>

<DD>
<I>threshold_lo/threshold_hi</I>
<BR>

This option causes the boxcar median smoothing filter to
operate with low and high
ratio thresholds (the value is changed only if the original
value divided by the median value is less than <I>threshold_lo</I>
or greater than <I>threshold_hi</I>). This allows the
filter to preferentially despike the data. In particular, this
approach is useful for suppressing &quot;stripes&quot; or &quot;bad&quot; 
pings which have amplitude or sidescan values differing significantly
from surrounding pings. This option only works with the median
smoothing filter.
<DT><B>-V</B>

<DD>
Normally, <B>mbfilter</B> works &quot;silently&quot; without outputting
anything to the stderr stream.  If the
<B>-V</B> flag is given, then <B>mbfilter</B> works in a &quot;verbose&quot; 
mode and outputs the program version being used, the values
of some important control parameters, and 
all error status messages.
<P>
</DL>
<A NAME="lbAH">&nbsp;</A>
<H2>EXAMPLES</H2>

Suppose one has a SeaBeam 2100 data file called test.mb41
which contains bathymetry (121 beams in a 120 degree swath), 
beam amplitude (121 beams coincident with bathymetry),
and sidescan data (2000 pixels, roughly a 150 degree swath)
which has been corrected for the amplitude vs grazing angle
variation using the program <B>mbanglecorrect</B>.
Plots of the corrected sidescan often show a large amount
of speckle that was suppressed in plots of the raw data
by the large contrast between the specular and non-specular
regions of the swath. To reduce the speckle and make coherent
features of the data clearer, the user can apply any of
the smoothing filters available in <B>mbfilter</B>. One iteration
of the boxcar mean filter can be applied as follows:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>mbfilter&nbsp;-F41&nbsp;-Itest.mb41&nbsp;-Otest_mean.mb41&nbsp;&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;</TT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>-S1/3/3/1<BR>
<BR>

Five iterations of the inverse gradient filter can be applied as follows:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>mbfilter&nbsp;-F41&nbsp;-Itest.mb41&nbsp;-Otest_igrad.mb41&nbsp;&nbsp;<TT>&nbsp;&nbsp;&nbsp;</TT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>-S4/3/3/5<BR>
<BR>

To remove large scale variations in seafloor reflectivity, one can
apply a hi-pass filter to the data:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>mbfilter&nbsp;-F41&nbsp;-Itest.mb41&nbsp;-Otest_hipass.mb41&nbsp;&nbsp;<TT>&nbsp;&nbsp;</TT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>-D1/3/10/1/10000<BR>
<BR>

To first apply a hi-pass filter to emphasize fine-scale structure
and then apply a lo-pass filter to reduce speckle:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>mbfilter&nbsp;-F41&nbsp;-Itest.mb41&nbsp;-Otest_hipass.mb41&nbsp;&nbsp;<TT>&nbsp;&nbsp;</TT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>-D1/3/10/1/10000&nbsp;-S4/3/3/5<BR>
<BR>

To first reduce speckle by smoothing the data with Gaussian
mean filter and apply an edge detection contrast enhancement
filter:
<BR>&nbsp;<TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>mbfilter&nbsp;-F41&nbsp;-Itest.mb41&nbsp;-Otest_hipass.mb41&nbsp;&nbsp;<TT>&nbsp;&nbsp;</TT><TT>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</TT>-S3/7/7/1&nbsp;-C1/5/5/1<BR>
<P>
<A NAME="lbAI">&nbsp;</A>
<H2>SEE ALSO</H2>

<B><A HREF="mbsystem.html">mbsystem</A></B>(l), <B><A HREF="mbbackangle.html">mbbackangle</A></B>(l), <B><A HREF="mbanglecorrect.html">mbanglecorrect</A></B>(l)
<P>
<A NAME="lbAJ">&nbsp;</A>
<H2>REFERENCES</H2>

Sauter, D., and L. Parson, Spatial filtering for speckle reduction,
contrast enchancement, and texture analysis of GLORIA images,
<I>IEEE J. Ocean. Eng.</I>, <B>19</B>, 563-576, 1994.
<P>
<A NAME="lbAK">&nbsp;</A>
<H2>BUGS</H2>

All the filtering in the world won't make bad data good.
<P>

<HR>
<A NAME="index">&nbsp;</A><H2>Index</H2>
<DL>
<DT><A HREF="#lbAB">NAME</A><DD>
<DT><A HREF="#lbAC">VERSION</A><DD>
<DT><A HREF="#lbAD">SYNOPSIS</A><DD>
<DT><A HREF="#lbAE">DESCRIPTION</A><DD>
<DT><A HREF="#lbAF">AUTHORSHIP</A><DD>
<DT><A HREF="#lbAG">OPTIONS</A><DD>
<DT><A HREF="#lbAH">EXAMPLES</A><DD>
<DT><A HREF="#lbAI">SEE ALSO</A><DD>
<DT><A HREF="#lbAJ">REFERENCES</A><DD>
<DT><A HREF="#lbAK">BUGS</A><DD>
</DL>
<HR>
</PRE>

<CENTER><P><BR>
Last Updated: 9 August 2001</P></CENTER>

<HR>
<P><A HREF="mbsystem_man_list.html">Return to list of MB-System manual pages...</A></P>
<P><A HREF="mbsystem_home.html"><IMG SRC="mbsystem_logo_small.gif" BORDER=0 HEIGHT=55 WIDTH=158 ALIGN=BOTTOM></A><A HREF="mbsystem_home.html">Back
to MB-System Home Page...</A></P>

</BODY>
</HTML>
